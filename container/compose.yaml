# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

services:
  aerial-framework-base:
    build:
      context: .
      dockerfile: Dockerfile
    image: ${REGISTRY}/${PROJECT}/${IMAGE_NAME}:${VERSION_TAG}
    container_name: "aerial-framework-base-${USER:-unknown}"
    working_dir: /opt/nvidia/aerial-framework
    stdin_open: true
    tty: true
    shm_size: 1gb
    user: "${USER_ID}:${GROUP_ID}"
    cap_add:
      - NET_ADMIN      # Configure network interfaces, required for DPDK NIC management
      - NET_RAW        # Create raw sockets, needed for raw Ethernet queue allocation
      - IPC_LOCK       # Lock memory for DMA operations and hugepage support
      - SYS_RAWIO      # Direct hardware access for VFIO/UIO drivers and PCIe config space
      - SYS_ADMIN      # Mount hugepages and manage system resources
      - SYS_NICE       # Set memory policies and NUMA affinity (fixes MPOL errors)
      - SYS_RESOURCE   # Override resource limits for memory allocation
      - SYS_PTRACE     # Allow ptrace access for LeakSanitizer
      - SETFCAP        # Set file capabilities, required for setcap command
    devices:
      - ${DEV_VFIO}:${DEV_VFIO}:rw
      - ${DEV_INFINIBAND}:${DEV_INFINIBAND}:rw
      - ${DEV_GDRDRV}:${DEV_GDRDRV}:rw
    volumes:
      - ${DEV_WORKSPACE}:/opt/nvidia/aerial-framework
      - ${BUILD_WORKSPACE}:/opt/nvidia/aerial-framework/out
      - /sys:/sys:ro  # System hardware info access (read-only)
      - ${DEV_HUGEPAGES}:/dev/hugepages:rw  # Hugepages with read-write access
      - ${HOME}/.ssh/known_hosts:/home/aerial/.ssh/known_hosts:ro  # SSH known hosts
      - ${SSH_AUTH_SOCK:-/tmp/dummy-ssh-agent}:/ssh-agent:ro  # SSH agent forwarding
    environment:
      - SSH_AUTH_SOCK=/ssh-agent
      - DISPLAY=${DISPLAY:-:0}
      - USER=${USER}
      - HOME=/home/aerial
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES}
      - NVIDIA_DRIVER_CAPABILITIES=all
      - AERIAL_FRAMEWORK_ROOT=/opt/nvidia/aerial-framework
      - USER_ID=${USER_ID}
      - GROUP_ID=${GROUP_ID}
      - DEV_WORKSPACE=${DEV_WORKSPACE}
      - BUILD_WORKSPACE=${BUILD_WORKSPACE}
      - DEV_VFIO=${DEV_VFIO}
      - DEV_INFINIBAND=${DEV_INFINIBAND}
      - DEV_GDRDRV=${DEV_GDRDRV}
      - DEV_HUGEPAGES=${DEV_HUGEPAGES}
    network_mode: host
    security_opt:
      - seccomp:./seccomp-sanitizers.json   # Custom seccomp profile for ThreadSanitizer and LeakSanitizer
    runtime: nvidia

